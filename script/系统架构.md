# 智能售货机行为视觉分析系统技术架构设计

## 1. 整体架构概览

### 1.1 架构原则
- **边缘-云端协同**：关键实时分析在边缘端完成，复杂分析和数据存储在云端
- **模块化设计**：各功能模块解耦，便于独立升级和维护
- **可扩展性**：支持横向扩展，适应不同规模的部署需求
- **安全性**：端到端数据加密，隐私保护设计

### 1.2 系统分层架构
```
┌─────────────────────────────────────────┐
│             应用层（SaaS）               │
├─────────────────────────────────────────┤
│             平台层（PaaS）               │
├─────────────────────────────────────────┤
│           基础设施层（IaaS）             │
├─────────────────────────────────────────┤
│             边缘计算层                   │
├─────────────────────────────────────────┤
│             端侧设备层                   │
└─────────────────────────────────────────┘
```

## 2. 详细架构设计

### 2.1 端侧设备层

#### 2.1.1 硬件组成
```
┌─────────────────────────────────────┐
│  智能售货机终端设备                  │
├─────────────┬──────────┬───────────┤
│ 视觉采集模块 │ 边缘计算盒 │ 通信模块   │
├─────────────┼──────────┼───────────┤
│ - 高清摄像头 │ - 算力单元 │ - 4G/5G模块│
│ - 红外补光  │ - 存储单元 │ - Wi-Fi模块│
│ - 广角镜头  │ - 管理模块 │ - 以太网口 │
└─────────────┴──────────┴───────────┘
```

**硬件规格要求：**
- **摄像头模块**：
  - 分辨率：至少1080P，推荐4K
  - 帧率：≥30fps
  - 传感器：低照度性能优异的CMOS传感器
  - 镜头：广角镜头，覆盖120°视野

- **边缘计算单元**：
  - 处理器：专用AI芯片（如华为昇腾、英伟达Jetson系列）
  - 内存：≥4GB RAM
  - 存储：≥32GB eMMC + 扩展SD卡槽
  - 接口：USB 3.0、GPIO、千兆以太网

- **通信模块**：
  - 支持4G/5G、Wi-Fi、有线网络
  - 断网本地存储和数据重传机制

#### 2.1.2 设备端软件架构
```
┌─────────────────────────────────────┐
│           设备管理代理               │
├─────────────────────────────────────┤
│    实时分析引擎（轻量化模型）         │
├─────────────┬────────────┬──────────┤
│  视频采集   │  AI推理引擎 │ 本地存储  │
│  与预处理   │            │  与缓存   │
├─────────────┼────────────┼──────────┤
│  OpenCV     │ TensorRT   │ SQLite   │
│  GStreamer  │ ONNX Runtime│ RocksDB  │
└─────────────┴────────────┴──────────┘
```

### 2.2 边缘计算层

#### 2.2.1 边缘服务器架构
```
┌─────────────────────────────────────┐
│        边缘计算节点（区域级）          │
├─────────────┬────────────┬──────────┤
│  边缘管理    │  AI模型服务  │ 数据网关  │
├─────────────┼────────────┼──────────┤
│  - 设备认证 │ - 模型更新   │ - 协议转换│
│  - 配置下发 │ - 模型推理   │ - 数据聚合│
│  - 状态监控 │ - 结果融合   │ - 缓存    │
└─────────────┴────────────┴──────────┘
```

**边缘节点配置：**
- **计算资源**：GPU服务器（如英伟达T4/Tesla系列）
- **网络架构**：区域内设备通过专线/VPN连接
- **部署策略**：按地理区域部署，每个节点管理50-200台设备

#### 2.2.2 边缘计算功能
- **实时行为分析**：处理设备端上报的实时视频流
- **模型热更新**：动态更新设备端AI模型
- **数据预处理**：视频质量检测、异常数据过滤
- **本地决策**：在断网时维持基本功能

### 2.3 云端平台层

#### 2.3.1 微服务架构设计
```
┌─────────────────────────────────────┐
│           API网关/负载均衡           │
├─────────────────────────────────────┤
│  微服务集群（容器化部署）             │
├──────┬──────┬───────┬──────┬───────┤
│设备管理│AI服务 │数据分析│告警服务│用户管理│
├──────┼──────┼───────┼──────┼───────┤
│Docker│Docker│Docker │Docker│Docker │
│K8s Pod│K8s Pod│K8s Pod │K8s Pod│K8s Pod│
└──────┴──────┴───────┴──────┴───────┘
```

#### 2.3.2 核心微服务组件

**1. 设备管理服务**
```yaml
服务名称: device-management
功能:
  - 设备注册与认证
  - 配置管理
  - 状态监控
  - 固件OTA升级
技术栈: Spring Boot + Redis + MySQL
```

**2. AI分析服务**
```yaml
服务名称: ai-analysis
功能:
  - 复杂行为识别
  - 模型训练与优化
  - 模型版本管理
  - 性能评估
技术栈: Python + TensorFlow/PyTorch + Triton推理服务
```

**3. 数据分析服务**
```yaml
服务名称: data-analytics
功能:
  - 实时数据处理（Flink）
  - 批量分析（Spark）
  - 用户画像构建
  - 销售预测
技术栈: Apache Flink + Apache Spark + ClickHouse
```

**4. 告警与通知服务**
```yaml
服务名称: alert-service
功能:
  - 实时异常检测
  - 告警规则引擎
  - 多渠道通知（短信/邮件/APP）
  - 告警处理跟踪
技术栈: Node.js + RabbitMQ + Elasticsearch
```

**5. 用户管理服务**
```yaml
服务名称: user-management
功能:
  - 权限管理（RBAC）
  - 组织架构管理
  - 操作审计
  - 单点登录
技术栈: Spring Security + OAuth2 + JWT
```

#### 2.3.3 数据存储架构

```
┌─────────────────────────────────────────┐
│            数据存储层                    │
├────────────┬──────────┬─────────────────┤
│  关系数据库 │  时序数据库 │  对象存储        │
├────────────┼──────────┼─────────────────┤
│ MySQL      │ InfluxDB │ MinIO/S3        │
│ PostgreSQL │ TDengine │                  │
│   - 设备信息 │ - 监控数据 │ - 视频文件      │
│   - 用户数据 │ - 传感器数 │ - 图片快照      │
│   - 配置数据 │ - 性能指标 │ - 日志文件      │
└────────────┴──────────┴─────────────────┘
```

**具体存储方案：**
- **业务数据**：MySQL集群（主从复制，读写分离）
- **时序数据**：TDengine（高效存储时间序列数据）
- **文件存储**：MinIO集群（兼容S3协议，自建对象存储）
- **缓存系统**：Redis集群（缓存热点数据，会话管理）
- **搜索引擎**：Elasticsearch（日志检索，数据分析）

### 2.4 AI算法架构

#### 2.4.1 模型分层设计
```
┌─────────────────────────────────────┐
│       应用层（业务逻辑）              │
├─────────────────────────────────────┤
│       算法层（核心模型）              │
├──────┬──────┬───────┬──────────────┤
│目标检测│行为识别│商品识别│异常检测      │
├──────┼──────┼───────┼──────────────┤
│YOLOv8│TSN/  │ResNet │ 异常检测      │
│      │SlowFast│ EfficientNet│算法       │
└──────┴──────┴───────┴──────────────┘
```

#### 2.4.2 具体算法实现

**1. 目标检测模块**
- **基础模型**：YOLOv8（设备端轻量化版本）
- **检测目标**：人体、手部、商品、支付设备
- **优化策略**：
  - 模型量化（INT8量化）
  - 知识蒸馏（大模型指导小模型）
  - 剪枝（移除冗余参数）

**2. 行为识别模块**
- **基础模型**：时空双流网络（Two-Stream Network）
- **识别能力**：
  - 空间流：静态姿态识别
  - 时间流：动作序列识别
- **算法优化**：轻量化的SlowFast网络变体

**3. 商品识别模块**
- **基础模型**：EfficientNet-B0
- **训练数据**：各商品多角度图片数据集
- **增强技术**：数据增强、迁移学习

**4. 异常检测模块**
- **技术方案**：
  - 基于规则的异常检测（简单场景）
  - 基于深度学习的异常检测（复杂场景）
  - 自编码器（Anomaly Detection Autoencoder）

### 2.5 通信架构

#### 2.5.1 通信协议设计
```
设备端 ──MQTT──> 边缘网关 ──gRPC──> 云端服务
        │                    │
        └<───CoAP────┘       └<───WebSocket─┘
```

**协议选择：**
- **设备到边缘**：MQTT 3.1.1（低功耗，适合不稳定网络）
- **边缘到云端**：gRPC（高效二进制传输，支持流式数据）
- **实时通知**：WebSocket（管理后台实时更新）
- **设备配置**：CoAP（低功耗设备配置）

#### 2.5.2 消息队列架构
```
┌─────────────────────────────────────┐
│          消息队列集群                │
├─────────────────────────────────────┤
│          Kafka集群                   │
├──────────┬──────────┬───────────────┤
│  设备数据 │ AI分析任务 │ 系统事件      │
│  Topic   │  Topic   │  Topic        │
└──────────┴──────────┴───────────────┘
```

**消息主题设计：**
- `vending/device/data`：设备上报数据
- `vending/ai/tasks`：AI分析任务队列
- `vending/alerts/events`：告警事件
- `vending/system/logs`：系统日志

### 2.6 安全架构

#### 2.6.1 多层级安全设计
```
┌─────────────────────────────────────┐
│        应用安全（API鉴权）            │
├─────────────────────────────────────┤
│        传输安全（TLS/SSL）           │
├─────────────────────────────────────┤
│        数据安全（加密存储）           │
├─────────────────────────────────────┤
│       设备安全（硬件安全模块）         │
└─────────────────────────────────────┘
```

#### 2.6.2 具体安全措施
- **设备认证**：基于证书的双向TLS认证
- **数据加密**：端到端AES-256加密
- **访问控制**：基于角色的访问控制（RBAC）
- **审计日志**：完整操作日志，不可篡改
- **防攻击**：WAF、DDoS防护、入侵检测

### 2.7 部署架构

#### 2.7.1 云原生部署
```yaml
# Kubernetes部署配置示例
apiVersion: apps/v1
kind: Deployment
metadata:
  name: ai-analysis-service
spec:
  replicas: 3
  selector:
    matchLabels:
      app: ai-analysis
  template:
    metadata:
      labels:
        app: ai-analysis
    spec:
      containers:
      - name: ai-analysis
        image: registry.example.com/ai-analysis:1.0.0
        resources:
          requests:
            memory: "2Gi"
            cpu: "1000m"
          limits:
            memory: "4Gi"
            cpu: "2000m"
        ports:
        - containerPort: 8080
```

#### 2.7.2 基础设施即代码
```terraform
# Terraform基础设施定义
resource "aws_vpc" "main" {
  cidr_block = "10.0.0.0/16"
}

resource "aws_eks_cluster" "vending_ai" {
  name     = "vending-ai-cluster"
  role_arn = aws_iam_role.eks_cluster.arn
  
  vpc_config {
    subnet_ids = [aws_subnet.public.id, aws_subnet.private.id]
  }
}
```

## 3. 关键技术选型

### 3.1 开发框架
- **后端**：Spring Cloud Alibaba微服务生态
- **前端**：Vue 3 + Element Plus
- **移动端**：Flutter（跨平台）
- **AI框架**：PyTorch + TorchServe

### 3.2 中间件
- **服务注册**：Nacos
- **配置中心**：Nacos
- **API网关**：Spring Cloud Gateway
- **分布式事务**：Seata

### 3.3 监控与运维
- **监控系统**：Prometheus + Grafana
- **日志系统**：ELK Stack（Elasticsearch, Logstash, Kibana）
- **链路追踪**：SkyWalking
- **容器编排**：Kubernetes + Helm

### 3.4 DevOps工具链
- **代码管理**：GitLab
- **CI/CD**：GitLab CI/CD
- **镜像仓库**：Harbor
- **安全扫描**：Trivy, SonarQube

## 4. 性能与扩展性设计

### 4.1 水平扩展策略
- **无状态服务**：微服务无状态设计，支持自动扩缩容
- **数据分片**：按设备ID分片存储数据
- **读写分离**：数据库主从架构，读操作分流

### 4.2 性能优化
- **CDN加速**：静态资源CDN分发
- **缓存策略**：多级缓存（Redis + 本地缓存）
- **异步处理**：非实时任务异步队列处理
- **连接池**：数据库、Redis连接池优化

## 5. 容灾与高可用

### 5.1 多可用区部署
```
Region: cn-east-1
├── Availability Zone A
│   ├── 主数据库
│   ├── 微服务实例
│   └── 消息队列
└── Availability Zone B
    ├── 备数据库
    ├── 微服务实例
    └── 消息队列副本
```

### 5.2 数据备份策略
- **实时备份**：数据库主从实时同步
- **定时备份**：每日全量备份 + 每小时增量备份
- **异地备份**：跨区域数据备份
- **恢复测试**：定期进行灾难恢复演练

## 6. 成本控制策略

### 6.1 云资源优化
- **弹性伸缩**：根据负载自动调整资源
- **预留实例**：长期运行的实例使用预留实例
- **存储分层**：热数据SSD，冷数据HDD
- **流量优化**：数据压缩，边缘计算减少云端流量

### 6.2 开源方案替代
- **数据库**：MySQL替代商业数据库
- **中间件**：RocketMQ替代商业消息队列
- **存储**：MinIO替代商业对象存储

## 7. 实施路线图

### 7.1 第一阶段（MVP，3个月）
- 基础设备端视觉采集
- 简单行为识别（选择-支付-取货）
- 基础管理后台
- 单区域试点部署（10台设备）

### 7.2 第二阶段（功能完善，4个月）
- 完整异常检测功能
- 商品识别与库存管理
- 数据分析报表
- 多区域扩展（100台设备）

### 7.3 第三阶段（规模化，5个月）
- 性能优化与稳定性提升
- AI模型持续优化
- 自动化运维系统
- 全国范围部署（1000+台设备）

---

**技术架构版本**：V1.0  
**设计团队**：zsscode 
**评审日期**：2025年12月  
*